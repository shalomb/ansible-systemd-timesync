---

# tasks file for systemd-timesyncd/tests

- name:  Get timedatectl status
  shell: timedatectl status
  register: timedatectl_status
  changed_when:  False
  failed_when: False
  tags:
    - test
    - assert

- name:  Get timedatectl timesync-status
  shell: timedatectl timesync-status
  register: timedatectl_timesync_status
  changed_when:  False
  failed_when: False
  tags:
    - test
    - assert

- name:  Get systemctl status systemd-timesyncd
  shell: systemctl status systemd-timesyncd
  register: timesyncd_status
  changed_when:  False
  failed_when: False
  tags:
    - test
    - assert

- name: Assert systemd-timesyncd status
  assert:
    that: '{{ item.assertion }}'
    msg:  '{{ item.message   }}'
  with_items:

    - assertion: "timesyncd_status.stdout | regex_search('Active:.*running')"
      message:   'systemd-timesyncd does not appear to be running'

  tags:
    - test
    - assert

- name: Assert timedatectl status
  assert:
    that: 'timedatectl_status.stdout | regex_search("{{ item.regex }}")'
    msg:  '{{ item.fail_msg }}'
  with_items:

    - regex:    'NTP service: active'
      fail_msg: 'timedatectl status does not report NTP service as active'

    - regex:    'synchronized: yes'
      fail_msg: 'timedatectl status does not report timesyncd as NTP synchronized'

    - regex:    'Time zone:s {{ default.timezone }}'
      fail_msg: 'timedatectl status expects timezone to be {{ default.timezone }}'

  tags:
    - test
    - assert

- name: Assert timedatectl timesync-status
  assert:
    that: 'timedatectl_timesync_status.stdout | regex_search("{{ item.regex }}")'
    msg:  '{{ item.fail_msg }}'
  with_items:

    - regex:    'Server. \d+'
      fail_msg: 'timesyncd status does not report synchronizing with a server'

    - regex:    'Stratum. \d+'
      fail_msg: 'timesyncd status does not report stratum of server'

    - regex:    'Poll interval. \d+'
      fail_msg: 'timesyncd status does not report ntp poll interval'

    - regex:    'Delay: \d+'
      fail_msg: 'timesyncd status does not report NTP delay'

  tags:
    - test
    - assert
